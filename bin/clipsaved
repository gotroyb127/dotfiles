#!/bin/sh

set -o nounset

: "${CS_SELECTIONS=primary clipboard}"
: "${CS_DIR:="${XDG_RUNTIME_DIR-"${TMPDIR-/tmp}"}"}"
: "${CS_DEBUG=}"
: "${CS_MAXCACHED:=200}"

LOCKED=
tmpf=
cachedir=$CS_DIR/clipsave.$USER
lockfile=$cachedir/CS.lck
activecachesfile=$cachedir/ActiveCaches

if [ -n "$CS_DEBUG" ]
then
	debug() {
		printf '%s\n' "$@" >&2
	}
	debug "Debuging is enabled."
else
	debug() { : ; }
fi

_mv() {
	if ! mv "$@"
	then
		debug "mv $*"
	fi
}

_mktemp() {
	[ -f "$tmpf" ] && return 0
	tmpf=$(mktemp)
}

die() {
	printf '%s\n' "$@" >&2
	exit $1
}

cleanquit() {
	if [ -n "$LOCKED" ]
	then
		rm -R "$cachedir"
	fi

	exit
}

initfiles() {
	rm -Rf "$cachedir"
	mkdir -p -m0700 "$cachedir"
	touch "$activecachesfile"
	if [ -f "$lockfile" ]
	then
		die 5 "Lock file '$lockfile' exists. Maybe another instance is already running."
	else
		touch "$lockfile"
		LOCKED=YES
	fi
}

managenewsel() {
	for sel in $CS_SELECTIONS
	do
		_mktemp
		xsel --$sel -o > "$tmpf"
		tmpcksum=$(cksum "$tmpf")

		fname="$cachedir/${tmpcksum%% *}"

		if [ "$(head -1 "$tmpf")" = "" ] || [ -f "$fname" ]
		then
			debug "Skipping caching from $sel."
			continue
		fi
		_mv -f "$tmpf" "$fname"
		debug "Grapped from $sel: '$fname'."

		printf '%s\n' "$fname" >> "$activecachesfile"
	done
}

managecachedsel() {
	_mktemp
	tail "-$CS_MAXCACHED" "$activecachesfile" | sort > "$tmpf"
	_mv -f "$tmpf" "$activecachesfile"

	{ cat "$activecachesfile"
	  printf '%s\n' "$cachedir/"[0-9]*
	} | sort | uniq -u |
		while read -r f
		do
			rm -f "$f"
		done
}

trap 'cleanquit' INT
trap 'exec $0 "$@"' HUP

initfiles
while true
do
	managenewsel
	managecachedsel

	clipnotify &
	wait $!
done
