#!/bin/sh

set nohidden
set dircounts
set incsearch
set info size
set icons
set number
set nodrawbox
set relativenumber
set period 1
set findlen 2
set anchorfind
set scrolloff 7
set previewer LF_Previewer
set cleaner LF_Cleaner
set shell ksh
set shellopts '-f'
set filesep "\n"
set ifs "\n"

cmd open      $Open.sh "$f"
cmd OpenSel   $Open.sh "$fx"
cmd EchoSel   !LF_Clear; echo "$fs" | LF_Fihi
cmd Ulm       &LF_MarkSave \'
cmd SelRecurs &find "$f" | sort "$@" | LF_Toggle
cmd REsel     &LF_Pattern "$@" | LF_Toggle
cmd Resource  &{{
	f="$XDG_CONFIG_HOME/lf/lfrc"
	lf -remote "send $id source '$f'"
	lf -remote "send $id echo 'Configuration file ($(echo "$f" | LF_Fihi)) loaded.'"
}}

cmd Yankname &{{
	[ -z "$f" ] && t="$PWD" || t="$f"
	echo -n "${t##*/}" | xsel
	echo -n "$t" | xsel -b
}}

cmd SetPrompt &{{
	B='\033[38;2;15;251;191m'
	T='\033[38;2;255;200;170m'
	L='\033[38;2;95;255;135m'
	D='\033[38;2;128;128;255m'
	N='\033[0m'
	ID="$T$id"
	CO="\033[38;5;252m:"
	LV="$L$LF_LEVEL"
	CD="$D%w"
	CF="$N%f"

	lf -remote "send $id set promptfmt \"$B[$ID$CO$LV$B] $CD$CF\""
}}

cmd Recol &{{
	w=$(tput cols)
	N="$IFS"
	if [ "$w" -le 75 ]
	then
		lf -remote "send $id set nopreview${N}send $id set ratios 1"
	elif [ "$w" -le 180 ]
	then
		lf -remote "send $id set ratios 7:8${N}send $id set preview"
	else
		lf -remote "send $id set ratios 9:16${N}send $id set preview"
	fi
}}

cmd Trash &{{
	{ N="$IFS"
	mkdir -p "$TRASH"
	LF_Move "mv${N}-v${N}--" "$TRASH" NO_DUPS
	lf -remote "send load${N}"
	} | LF_Log
}}

cmd rm !{{
	LF_Clear
	printf "--- Files to be removed: ---\n\n%s\n\nDelete? [Y/n]: " "$fx" \
		| LF_Fihi
	read ans
	if [ "$ans" != y ]
	then
		messg='Aborted'
	elif rm -vfR $fx | LF_Log
	then
		messg='DONE'
	else
		messg='SOME ERROR OCCURED'
	fi
	printf "\n--- $messg ---\n"
}}

cmd Paste &{{
	{ N="$IFS"
	if [ "X$1" = 'X--inside' -a -d "$f" ]
	then
		DEST=$f
	else
		DEST=$PWD
	fi
	load=$(lf -remote 'load')
	mode=$(echo "$load" | sed -n '1p')
	list=$(echo "$load" | sed '1d')
	if [ $mode = copy ]
	then
		OP="cp${N}-Rv${N}--"
		DUPS=
	elif [ $mode = move ]
	then
		OP="mv${N}-v${N}--"
		DUPS=NO
	fi
	export fx="$list"
	LF_Move "$OP" $DEST $DUPS | sed "s!'$HOME!'~!g"
	lf -remote "send load${N}send clear"
	} | LF_Log
}}

map a %du -hd0 "$f" 2> /dev/null | awk '{print $1"  "}' | tr -d '\n'; ls -lhd "$f"
map A !LF_Clear; LF_Du
map R :Resource

map sn :set sortby natural
map sN :set sortby name

map v
map vv :invert
map vr :set reverse!; invert; set reverse!
map vj :toggle; down
map vk :toggle; up
map vt :toggle
map Vv :SelRecurs
map VV :SelRecurs; down
map Vr :SelRecurs -r
map VR :SelRecurs -r; up

map Jj %LF_Jump -type f
map Jd %LF_Jump -type d
map Ja %LF_Jump

map i $nvim -MR "$f"
map I $LF_Previewer "$f" | nl | less -R
map w $exec $SHELL
map W !:
map q :Ulm; quit
map Q :quit
map <c-w> :${{ let --LF_LEVEL; exec $SHELL }}; quit
map p :Paste
map P :Paste --inside
map E :push $nvim<space>""<left>
map D :push $mkdir<space>""<left>
map x :push $chmod<space>+x<space>"$f"
map X !LF_Clear; "$f"
map C !printf %s "$fx" | vidir -v -
map ` $nvim -MR "${TMPDIR:-/tmp}/lf.$USER.$id.log"

map <c-y> :up
map <c-e> :down
map <c-l> :Recol; SetPrompt; redraw
map <c-r> :reload
map c     :clear; unselect

map <delete>  :Trash
map <c-space> :toggle; up
map <enter>   :OpenSel
map <c-j>     :OpenSel
map Y :Yankname; echo Filename Yanked.
map Kk :set nopreview; set ratios 1
map KK :set ratios 14:16; set preview
map Kl :set ratios 9:16; set preview

map r
map re :rename; cmd-word-back; cmd-left
map rA :rename
map rS :rename; cmd-delete-home
map rI :rename; cmd-home

map bb :set drawbox!
map bv :set preview!
map bn :set relativenumber!
map bN :set number!
map bi :set icons!

map Sp &xsel -o  | LF_Toggle
map Sc &xsel -bo | LF_Toggle
map SS &LF_SelShuf shuf
map Ss :EchoSel
map Sg :push :glob-select<space>
map SG :push :glob-unselect<space>
map Sr :push :REsel<space>

map gr cd /
map ge cd /etc
map gb cd /bin
map gv cd /var
map gT cd /tmp
map gm cd /mnt
map gh cd ~
map gl cd ~/.local
map gs cd ~/.local/scripts
map gS cd ~/.local/bin
map gt cd ~/.local/trash
map gd cd ~/Documents
map gD cd ~/Downloads
map gc &lf -remote "send $id cd '${XDG_CONFIG_HOME:-\"$HOME/.config\"}'"

Recol; SetPrompt
