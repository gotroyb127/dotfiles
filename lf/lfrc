#!/bin/sh
# ^^^ trick vim to syntax highlihght

set hidden
set color256
set dircounts
set incsearch
set info size
set icons
set number
set drawbox
set relativenumber
set period 1
set findlen 2
set anchorfind
set scrolloff 5
set previewer ~/.local/etc/lf/scope.sh
set promptfmt "\033[0;38;5;7m[\033[0;38;5;45m%u\033[0;38;5;195m@\033[0;38;5;42m%h\033[0;38;5;7m]:\033[1;38;5;105m%w/\033[0;38;5;15m%f\033[0m"
set shell mksh

#cmd on-cd $cd "$(dirname "$f")"
#cmd Wait $bash -c 'read -sn1'
cmd open ${{ IFS=$'\n'; Open.sh "$f" }}
cmd OpenSel ${{ IFS=$'\n' Open.sh "$fx" }}

cmd SelRecurs %{{
	IFS=$'\n'
	N=$'\n'
	[[ ! -d $f ]] && exit 0
	for d in $(find $f -type d | sort); do
		lf -remote "send $id select '$d'${N}send $id open${N}send $id invert"
	done
	lf -remote "send $id select '$f'"
}}

cmd delete ${{
	IFS=$'\n'
	clear -x
	echo -n "---\tFiles to be deleted:\t---\n\n$fx\n\nDelete? [Y/n]: " \
	| sed "s/^${HOME//\//\\/}/~/g"
	read -n1 ans
	[[ $ans = !(y|Y) ]] && exit 0;
	mkdir -p /tmp/Trash
	chmod 777 /tmp/Trash
	a=0
	DEST=/tmp/Trash
	for i in $fx; do
		((++a))
		d=$(dirname "$i")
		[[ $d = $DEST ]] && continue
		i=$(basename "$i")
		! [[ -e $DEST/$i ]] && 
			mv -i "$d/$i" $DEST &&
			continue
		s=$(echo $i | grep -o ' ([0-9]\+)$' | head -n1 | tr -d '()')
		[[ -z $s ]] && s=1 || ((++s))
		p=$(echo $i | sed 's/\ ([0-9]*)$//g')
		newn="$DEST/$p ($s)"
		echo $newn
		while [[ -e $newn ]]; do
			newn="$DEST/$p ($((++s)))"
		done
		mv -i "$d/$i" "$newn"
	done
	echo -e "\n\n--- $a Objects moved to /tmp/Trash. ---"
	bash -c 'read -sn1'
}}

cmd Trash ${{
	IFS=$'\n'
	DEST=~/.local/trash
	for i in $fx; do
		d=$(dirname "$i")
		[[ $d = $DEST ]] && continue
		i=$(basename "$i")
		! [[ -e $DEST/$i ]] && 
			mv -iv "$d/$i" $DEST &&
			continue
		s=$(echo $i | grep -o ' ([0-9]\+)$' | head -n1 | tr -d '()')
		[[ -z $s ]] && s=1 || ((++s))
		p=$(echo $i | sed 's/\ ([0-9]*)$//g')
		newn="$DEST/$p ($s)"
		echo $newn
		while [[ -e $newn ]]; do
			newn="$DEST/$p ($((++s)))"
		done
		mv -iv "$d/$i" "$newn"
	done
}}

cmd paste %{{
	IFS=$'\n'
	N=$'\n'
	load=$(lf -remote 'load')
	mode=$(echo "$load" | sed -n '1p')
	list=$(echo "$load" | sed '1d')
	if [[ $mode = copy ]]; then
	    Op="cp${N}-nR"
	elif [[ $mode = move ]]; then
	    Op="mv${N}-n"
	fi
	DEST=$(pwd)
	for i in $list; do
		d=$(dirname $i)
		[[ $d = $DEST && mode = move ]] && continue
		i=$(basename $i)
		! [[ -e $DEST/$i ]] && 
			$Op "$d/$i" $DEST &&
			continue
		s=$(echo $i | grep -o ' ([0-9]\+)$' | head -n1 | tr -d '()')
		[[ -z $s ]] && s=1 || ((++s))
		p=$(echo $i | sed 's/\ ([0-9]*)$//g')
		newn="$DEST/$p ($s)"
		echo $newn
		while [[ -e $newn ]]; do
			newn="$DEST/$p ($((++s)))"
		done
		$Op $d/$i $newn
	done
	lf -remote "send load${N}send clear"
}}

cmd Recol &{{
	w=$(tput cols)
	N=$'\n'
	if [ $w -le 75 ]; then
		lf -remote "send $id set nopreview${N}send $id set ratios 1"
	elif [ $w -le 220 ]; then
		lf -remote "send $id set ratios 11:16${N}send $id set preview"
	else
		lf -remote "send $id set ratios 7:16${N}send $id set preview"
	fi
}}

cmd Yankname &{{
	if [ -z "$f" ]; then
		t="$PWD"
	else
		t="$f"
	fi
	basename "$t" | tr -d '\n' | xclip
	echo -n "$t" | xclip -sel clipboard
}}

cmd EchoSelection !clear -x && echo "$fx" | sort -n

cmd Resource :source ~/.config/lf/lfrc
map R :{{
	Resource
	%sleep .01 && lf -remote "send $id echoerr 'Configuration file (~/.config/lf/lfrc) loaded.'"
}}

map C !IFS=$'\n'; vidir -v $fx

map X !clear -x && "$f"

map a %du -hd0 "$f" 2> /dev/null | awk '{print $1"  "}' | tr -d '\n'; ls --color=always -lhd "$f"
map A !clear -x && du -hd1 | sort -k 1 -rh && ls -aSlh | grep -v '^d\|^l' | awk '{printf("%s\t%s \n", $5, $9) }'

map Sp &xclip -o | LF_Select.sh
map Sc &xclip -o -sel clipboard | LF_Select.sh
map Ss :EchoSelection

map sn :set sortby natural
map sN :set sortby name

map Jj %LF_Jump.sh -type f
map Jd %LF_Jump.sh -type d
map Ja %LF_Jump.sh

map <delete> :Trash
map Y :Yankname; echoerr Filename Yanked.
map M :SelRecurs
map L :OpenSel

map i $nvim -MR "$f"
map E push $nvim<space>""<left>
map D push $mkdir<space>""<left>
map x push $chmod<space>+x<space>"$f"

map <c-y> up
map <c-e> down
map <c-l> :Recol
map <esc> cmd-escape
map <c-r> :redraw; reload
map c :clear; unselect

map r
map re :rename; cmd-word-back; cmd-left
map rA :rename
map rS :rename; cmd-delete-home
map rI :rename; cmd-home

map bb :set drawbox!
map bv :set preview!
map bn :set relativenumber!
map bN :set number!
map bi :set icons!

map gr cd /
map ge cd /etc
map gT cd /tmp
map gl cd ~/.local
map gc cd ~/.local/etc
map gs cd ~/.local/scripts
map gt cd ~/.local/trash
map gd cd ~/Documents
map gD cd ~/Downloads

set ratios 11:16
Recol
